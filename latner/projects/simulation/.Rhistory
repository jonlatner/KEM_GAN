filter(ch_de_west!=0)
df_germany_f <- df_germany %>%
# keep if adult poverty outcomes observed
# filter(!is.na(poverty_2426)) %>%
# keep if childhood poverty is not missing
# filter(!is.na(chpov)) %>%
# drop variable `poor_young_adult`
select(-any_of("poor_young_adult")) %>%
# keep only rows in the adult age band
filter(age >= minage, age <= maxage) %>%
group_by(id) %>%
slice(1) %>%
ungroup() %>%
filter(ch_de_west!=0)
df_germany_f <- df_germany %>%
# keep only rows in the adult age band
filter(age >= minage, age <= maxage) %>%
# keep if childhood poverty is not missing
# filter(!is.na(chpov)) %>%
group_by(id) %>%
slice(1) %>%
ungroup() %>%
filter(ch_de_west!=0)
df_germany_f <- df_germany %>%
# keep only rows in the adult age band
filter(age >= minage, age <= maxage) %>%
# keep if childhood poverty is not missing
filter(!is.na(chpov)) %>%
group_by(id) %>%
slice(1) %>%
ungroup() %>%
filter(ch_de_west!=0)
df_germany_f <- df_germany %>%
# keep only rows in the adult age band
filter(age >= minage, age <= maxage) %>%
# keep if childhood poverty is not missing
filter(ch_n_obs>=5) %>%
# filter(!is.na(chpov)) %>%
group_by(id) %>%
slice(1) %>%
ungroup() %>%
filter(ch_de_west!=0)
# Top commands ----
# https://stackoverflow.com/questions/7505547/detach-all-packages-while-working-in-r
detachAllPackages <- function() {
basic.packages <- c("package:stats","package:graphics","package:grDevices","package:utils","package:datasets","package:methods","package:base")
package.list <- search()[ifelse(unlist(gregexpr("package:",search()))==1,TRUE,FALSE)]
package.list <- setdiff(package.list,basic.packages)
if (length(package.list)>0)  for (package in package.list) detach(package, character.only=TRUE)
}
detachAllPackages()
rm(list=ls(all=TRUE))
# FOLDERS
# setwd("//iab.baintern.de/DFS/017/Ablagen/D01700-Projekte/D01700-Intergenerational_Hartz_IV/Latner/")
setwd("/Users/jonathanlatner/Google Drive/My Drive/IAB/D01700-Intergenerational_Hartz_IV/Latner/")
data_input = "data_input/SOEP/2018/"
tables = "tables/SOEP/2018/"
# LIBRARY
library(tidyverse)
library(Hmisc)
options(scipen = 999) # disable scientific notation
# LOAD SOEP-ADIAB DATA ----
df_germany <- readRDS(file = paste0(data_input,"Germany.rds"))
# Clean data ----
# rename variables
df_germany <- df_germany %>%
rename(
year = syear,
hh_net_inc = i11102,
age = d11101,
id = x11101ll,
hhsize = d11106,
weight_ind = w11101,
) %>%
select(id, year, age, hhsize, hh_net_inc, weight_ind,l11102)  %>%
filter(year <= 2016)
# Clean data ----
df_germany <- df_germany %>%
mutate(across(everything(), ~ ifelse(.x < 0, NA, .x)))
df_germany <- df_germany %>%
filter(!is.na(age)) %>%
filter(!is.na(hh_net_inc))
summary(df_germany)
# age
minage <- 25
maxage <- 35
# Generate the equivalized hh income, which is hh_net_inc/squared root of number of ppl in the household.
df_germany <- df_germany %>%
mutate(
hh_net_inc_eq    = hh_net_inc / sqrt(hhsize),
)
# Annual thresholds (overall)
thresh_whole <- df_germany %>%
group_by(year) %>%
summarise(
annual_median_income_whole = as.numeric(
wtd.quantile(hh_net_inc_eq, weights = weight_ind, probs = 0.5, na.rm = TRUE)
),
.groups = "drop"
)
# Join thresholds back and compute poverty (unchanged)
df_germany <- df_germany %>%
left_join(thresh_whole, by = "year") %>%
mutate(
annual_median_income_sel = annual_median_income_whole,
poverty = case_when(
is.na(hh_net_inc_eq) | is.na(annual_median_income_sel) ~ NA,
TRUE ~ as.integer(hh_net_inc_eq < 0.5 * annual_median_income_sel)
),
) %>%
select(-matches("annual_median_income"))
rm(thresh_whole)
# GERMANY: EAST OR WEST? ----
df_germany <- df_germany %>%
mutate(
de_west = case_when(
l11102 == 1 ~ 1L,
l11102 == 2 ~ 0L,
TRUE        ~ NA_integer_
)
)
# Mean de_west during childhood (0â€“17), then attach a per-id constant
ch_west_by_id <- df_germany %>%
filter(age >= 0, age <= 17) %>%
group_by(id) %>%
summarise(ch_de_west = mean(de_west, na.rm = TRUE), .groups = "drop")
df_germany <- df_germany %>%
left_join(ch_west_by_id, by = "id")
rm(ch_west_by_id)
# Childhood poverty:----
# POST-TRANSFER
#Note: the following command only creates chpov to people who are observed for 5 or more years before 17 yo. [do not use mean since it assigns 0 for people who are not observed in the range
# childhood flag (age 10 - 17)
df_germany <- df_germany %>%
mutate(child = age >= 0 & age <= 17)
summary(df_germany)
# Count non-missing poverty observations in childhood,
# then compute mean poverty in childhood if count >= 5; else NA
df_germany <- df_germany %>%
group_by(id) %>%
mutate(
ch_n_obs = sum(child, na.rm = TRUE),
chpov = if_else(
ch_n_obs >= 5,
mean(poverty[child], na.rm = TRUE),   # share of childhood years in poverty
NA_real_
)
) %>%
ungroup() %>%
mutate(ind_chpov = ifelse(chpov>0,1,0))
# an adolescent (10-17) can be observed more than 8 times if they are the same age in 2 different surveys
table(df_germany$ch_n_obs)
# Poverty in young adulthood ----
df_germany_youngadult <- df_germany %>%
arrange(id,year) %>%
filter(age >= minage & age <= maxage) %>%
group_by(id) %>%
mutate(
poverty_2426a = mean(poverty, na.rm = TRUE),
) %>%
ungroup() %>%
select(id, year, age, poverty_2426a) %>%
distinct()
df_germany <- df_germany %>%
left_join(df_germany_youngadult, by = c("id","year","age")) %>%
mutate(youngadult = age >= minage & age <= maxage) %>%
group_by(id) %>%
mutate(poverty_2426 = mean(poverty_2426a, na.rm = TRUE),
yth_n_obs = sum(youngadult & !is.na(poverty), na.rm = TRUE),
) %>%
ungroup() %>%
select(-poverty_2426a)%>%
mutate(ind_youthpov = ifelse(poverty_2426>0,1,0))
rm(df_germany_youngadult)
# filter ----
# keep only rows in the adult age band
df_germany_1 <- df_germany %>%
filter(age >= minage, age <= maxage) %>%
group_by(id) %>%
slice(1) %>%
ungroup() %>%
filter(ch_de_west!=0)
n_young_adults <- nrow(df_germany_1)
# must be observed at least 5 times in childhood (0-17)
df_germany_2 <- df_germany %>%
filter(age >= minage, age <= maxage) %>%
filter(ch_n_obs>=5) %>%
group_by(id) %>%
slice(1) %>%
ungroup()
n_child_observed <- nrow(df_germany_2)
pct_child_observed <- n_child_observed / n_young_adults
# the Germany sample excludes individuals who spent all of their childhood in East Germany.
df_germany_3 <- df_germany %>%
filter(age >= minage, age <= maxage) %>%
filter(ch_n_obs>=5)%>%
filter(ch_de_west!=0)  %>%
group_by(id) %>%
slice(1) %>%
ungroup()
n_west_observed <- nrow(df_germany_3)
pct_west_observed <- n_west_observed / n_young_adults
n_west_observed
# 3. Individuals who experienced child poverty
n_child_poverty <- df_germany_ya_child %>%
filter(age >= minage, age <= maxage) %>%
filter(ch_n_obs>=5)%>%
filter(ch_de_west!=0)  %>%
summarise(n = sum(ind_chpov == 1, na.rm = TRUE))  %>%
group_by(id) %>%
slice(1) %>%
ungroup() %>%
pull(n)
# 3. Individuals who experienced child poverty
n_child_poverty <- df_germany %>%
filter(age >= minage, age <= maxage) %>%
filter(ch_n_obs>=5)%>%
filter(ch_de_west!=0)  %>%
summarise(n = sum(ind_chpov == 1, na.rm = TRUE))  %>%
group_by(id) %>%
slice(1) %>%
ungroup() %>%
pull(n)
# 3. Individuals who experienced child poverty
n_child_poverty <- df_germany %>%
filter(age >= minage, age <= maxage) %>%
filter(ch_n_obs>=5)%>%
filter(ch_de_west!=0)  %>%
group_by(id) %>%
slice(1) %>%
ungroup() %>%
summarise(n = sum(ind_chpov == 1, na.rm = TRUE))  %>%
pull(n)
n_child_poverty
# 4. Individuals who experienced young adult poverty
n_ya_poverty <- df_germany_ya_child %>%
filter(age >= minage, age <= maxage) %>%
filter(ch_n_obs>=5)%>%
filter(ch_de_west!=0)  %>%
group_by(id) %>%
slice(1) %>%
ungroup() %>%
summarise(n = sum(ind_youthpov == 1, na.rm = TRUE))  %>%
pull(n)
# 4. Individuals who experienced young adult poverty
n_ya_poverty <- df_germany %>%
filter(age >= minage, age <= maxage) %>%
filter(ch_n_obs>=5)%>%
filter(ch_de_west!=0)  %>%
group_by(id) %>%
slice(1) %>%
ungroup() %>%
summarise(n = sum(ind_youthpov == 1, na.rm = TRUE))  %>%
pull(n)
n_ya_poverty
# 5. Individuals who experienced young adult poverty
n_both_poverty <- df_germany %>%
filter(age >= minage, age <= maxage) %>%
filter(ch_n_obs>=5)%>%
filter(ch_de_west!=0)  %>%
group_by(id) %>%
slice(1) %>%
ungroup() %>%
summarise(n = sum(ind_youthpov == 1 & ind_chpov == 1, na.rm = TRUE))  %>%
pull(n)
n_both_poverty
pct_both_poverty <- n_both_poverty / n_west_observed
pct_both_poverty
pct_youth_poverty
pct_youth_poverty <- n_ya_poverty / n_west_observed
pct_youth_poverty
pct_child_poverty <- n_child_poverty / n_west_observed
pct_child_poverty
# 3. Individuals who experienced child poverty
n_child_poverty <- df_germany %>%
filter(age >= minage, age <= maxage) %>%
filter(ch_n_obs>=5)%>%
filter(ch_de_west!=0)  %>%
group_by(id) %>%
slice(1) %>%
ungroup() %>%
summarise(n = mean(chpov))  %>%
pull(n)
n_child_poverty
# 3. Individuals who experienced child poverty
n_child_poverty <- df_germany %>%
filter(age >= minage, age <= maxage) %>%
filter(ch_n_obs>=5)%>%
filter(ch_de_west!=0)  %>%
group_by(id) %>%
slice(1) %>%
ungroup() %>%
summarise(n = sum(ind_chpov == 1))  %>%
pull(n)
n_child_poverty
pct_child_poverty <- n_child_poverty / n_west_observed
pct_child_poverty
# 3. Individuals who experienced child poverty
n_child_poverty <- df_germany %>%
filter(age >= minage, age <= maxage) %>%
filter(ch_n_obs>=5)%>%
filter(ch_de_west!=0)  %>%
group_by(id) %>%
slice(1) %>%
ungroup() %>%
summarise(n = sum(ind_chpov == 1),
pct = mean(chpov))  %>%
pull(n,pct)
n_child_poverty
n_child_poverty
n_child_poverty[1]
n_child_poverty[2]
n_child_poverty[1,]
n_child_poverty[1,1]
n_child_poverty
# 3. Individuals who experienced child poverty
n_child_poverty <- df_germany %>%
filter(age >= minage, age <= maxage) %>%
filter(ch_n_obs>=5)%>%
filter(ch_de_west!=0)  %>%
group_by(id) %>%
slice(1) %>%
ungroup() %>%
summarise(n = sum(ind_chpov == 1),
pct = mean(chpov))
n_child_poverty
n_child_poverty$n
# 4. Individuals who experienced young adult poverty
n_ya_poverty <- df_germany %>%
filter(age >= minage, age <= maxage) %>%
filter(ch_n_obs>=5)%>%
filter(ch_de_west!=0)  %>%
group_by(id) %>%
slice(1) %>%
ungroup() %>%
summarise(n = sum(ind_youthpov == 1),
pct = mean(poverty_2426))
n_ya_poverty
# Top commands ----
# Create empty R application (no figures, data frames, packages, etc.)
# Get a list of all loaded packages
packages <- search()[grepl("package:", search())]
# Unload each package
for (package in packages) {
unloadNamespace(package)
}
rm(list=ls(all=TRUE))
# load library
library(synthpop)
library(tidyverse)
library(xtable)
# FOLDERS - ADAPT THIS PATHWAY
main_dir = "/Users/jonathanlatner/Documents/GitHub/KEM_GAN/latner/projects/simulation/"
data_files = "data_files/"
original_data = "data_files/original/"
synthetic_data = "data_files/synthetic/synthpop/"
graphs = "graphs/"
tables = "tables/"
setwd(main_dir)
#functions
options(scipen=999)
my.seed = 1237
# Load original data ----
df_ods <- read.csv(paste0(original_data,"simulated.csv"))
# Load synthetic data ----
sds <- syn(df_ods, m = 1, seed = my.seed)
t5 <- disclosure(sds, df_ods, keys = c("var1", "var2", "var3"), target = "var4", print.flag = FALSE)
ttest1 <- print(t5, to.print = "allCAPs")
sds <- syn(df_ods, m = 5, seed = my.seed)
t5 <- disclosure(sds, df_ods, keys = c("var1", "var2", "var3"), target = "var4", print.flag = FALSE)
ttest1 <- print(t5, to.print = "allCAPs")
sds <- syn(df_ods, m = 10, seed = my.seed)
t5 <- disclosure(sds, df_ods, keys = c("var1", "var2", "var3"), target = "var4", print.flag = FALSE)
ttest1 <- print(t5, to.print = "allCAPs")
# Top commands ----
# Create empty R application (no figures, data frames, packages, etc.)
# Get a list of all loaded packages
packages <- search()[grepl("package:", search())]
# Unload each package
for (package in packages) {
unloadNamespace(package)
}
rm(list=ls(all=TRUE))
# load library
library(synthpop)
library(tidyverse)
library(xtable)
library(readr)
# FOLDERS - ADAPT THIS PATHWAY
main_dir = "/Users/jonathanlatner/Documents/GitHub/KEM_GAN/latner/projects/simulation/"
data_files = "data_files/"
original_data = "data_files/original/"
tables = "tables/"
synthetic_data = "data_files/synthetic/synthpop/"
setwd(main_dir)
#functions
options(scipen=999)
# Set seed for reproducibility
my.seed = 1237
set.seed(my.seed)
# Load original data ----
df_ods <- read.csv(paste0(original_data,"simulated.csv"))
# Load synthetic data ----
df_sds_10 <- read_csv(paste0(synthetic_data,"synthetic_cart_10.csv"))
sds <- syn(df_ods, m = 1, seed = my.seed)
df_sds_1 <- sds$syn
# Generate frequency lists ----
# df_ods
df_frequency <- df_ods
df_frequency$combine <- paste(df_frequency$var1, df_frequency$var2, df_frequency$var3, df_frequency$var4, sep = "")
df_frequency <- df_frequency %>%
select(-matches("var"))
df_frequency_ods <- as.data.frame(table(df_frequency))
df_frequency_ods_unique <- df_frequency_ods %>%
filter(combine == "1111")
df_frequency_ods_unique <- df_frequency_ods_unique$Freq
df_frequency_ods_unique
# df_sds_1
df_frequency_sds_1 <- df_sds_1
df_frequency_sds_1$combine <- paste(df_frequency_sds_1$var1, df_frequency_sds_1$var2, df_frequency_sds_1$var3, df_frequency_sds_1$var4, sep = "")
df_frequency_sds_1 <- df_frequency_sds_1 %>%
select(-matches("var"))
df_frequency_sds_1 <- as.data.frame(table(df_frequency_sds_1)) %>%
filter(combine == "1111")
sds_1_unique <- df_frequency_sds_1$Freq
sds_1_unique
# df_sds_10
df_frequency_ods$n <- 0
df_frequency_ods$type <- "original"
df_frequency_ods$n <- 0
df_frequency_sds_10 <- rbind(df_frequency_ods,df_sds_10) %>%
pivot_wider(names_from = "n", values_from = "Freq")  %>%
filter(combine == "1111") %>%
mutate(across(everything(), ~ replace_na(.x, 0))) %>%
pivot_longer(
cols = `0`:`10`,        # the range of columns to pivot
names_to = "value",     # new column that stores the old column names
values_to = "count",     # new column that stores the numbers
) %>%
filter((type == "original" & value == 0) | (type == "synthetic" & value > 0))
df_frequency_sds_10 %>% print(n=22)
df_frequency_sds_10_unique <- as.vector(df_frequency_sds_10$count)
df_frequency_sds_10_unique
# Disclosure measures ----
# create summary table
t1 <- multi.disclosure(sds, df_ods, print.flag = FALSE, plot = TRUE, keys = c("var1", "var2", "var3"), target = "var4")
ident = print(t1, plot = FALSE, to.print = "ident")
attrib = print(t1, plot = FALSE, to.print = "attrib")
ttest <- print(t1, plot = FALSE, to.print = "allCAPs")
ttest <- print(t1, plot = FALSE, to.print = "TCAP")
ttest
df_risk <- data.frame(
data = c("Original", "Synthetic"),
unique = c(df_frequency_ods_unique,sds_1_unique),
identity = c(t1$ident.orig,t1$ident.syn),
attribute = c(t1$attrib.table$attrib.orig, t1$attrib.table$attrib.syn)
)
df_risk
# Create the xtable object
latex_table <- xtable(df_risk)
colnames(latex_table) <- c("Data", "Unique", "Identity Risk ($repU$)", "Attribute Risk ($DiSCO$)")
print.xtable(latex_table,
include.rownames = FALSE,
floating = FALSE,
booktabs = TRUE,
sanitize.text.function = identity,
file = paste0(tables,"table_disclosure_risk_1.tex"))
# Create 10 synthetic data sets ----
df_sds <- syn(df_ods, m = 10)
for (c in 1:10) {
print(c)
# Create fake synthetic data
sds <- syn(df_ods, m = 1, seed = my.seed)
df_sds$syn[[c]] <- sds$syn
# create seed
my.seed = my.seed + 1
}
# create summary table
t1 <- multi.disclosure(df_sds, df_ods, print.flag = FALSE, plot = TRUE, keys = c("var1", "var2", "var3"), target = "var4")
t10 <- disclosure(df_sds, df_ods, keys = c("var1", "var2", "var3"), target = "var4", print.flag = FALSE)
ttest10 <- print(t10, to.print = "allCAPs")
df_risk <- data.frame(
data = c("Original", "Synthetic"),
identity = c(t1$ident.orig,t1$ident.syn),
attribute = c(t1$attrib.table$attrib.orig, t1$attrib.table$attrib.syn)
)
df_risk
# Table ----
t1 <- disclosure(df_sds, df_ods, print.flag = FALSE, plot = TRUE, keys = c("var1", "var2", "var3"), target = "var4")
repU <- t1$ident$repU
average_row <- mean(repU) # calculate average row across 10 synthetic data sets
repU <- c(0, repU, average_row)
DiSCO <- t1$attrib$DiSCO
average_row <- mean(DiSCO) # calculate average row across 10 synthetic data sets
DiSCO <- c(0, DiSCO, average_row)
df_frequency_sds_10_unique <- c(df_frequency_sds_10_unique, NA)
# create table
df_risk <- data.frame(
data = c("Original", "Synthetic 1", "Synthetic 2", "Synthetic 3", "Synthetic 4", "Synthetic 5", "Synthetic 6", "Synthetic 7", "Synthetic 8", "Synthetic 9", "Synthetic 10", "Average"),
unique = df_frequency_sds_10_unique,
identity = c(repU),
attribute = c(DiSCO)
)
df_risk
ttest10
ttest10$allCAPs
df_risk
# all caps table ----
df_test <- cbind(df_risk,ttest10$allCAPs)
# all caps table ----
df_risk
ttest10$allCAPs
