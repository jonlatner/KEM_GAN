# You should have received a copy of the GNU Lesser General Public License along with estimate_akm. If not, see        #
# <https://www.gnu.org/licenses/>.                                                                                     #
# -------------------------------------------------------------------------------------------------------------------- #
rm(list = ls())
options(crayon.enabled = FALSE)
library("data.table")
library("tidyr")
library("dplyr")
main_directory <- "/Users/jonathanlatner/Google Drive/My Drive/IAB/D01700-LatnerWunder/akm/estimate_akm-main"
source(paste0(main_directory,"/public_use/code/utils/akm_functions.R"))
source(paste0(main_directory,"/public_use/code/utils/functions_1.R"))
# -------------------------------------------------------------------------
log_path <- file(paste0(main_directory,"/public_use/logs/1_simulate_data.txt"), open = "wt")
log_open(log_path)
p_move <- 0.25 # probability of a worker switching firms from period t to t+1
set.seed(1992)
n_jobs <- 1E5
job_data <- data.table(person_id = 1:n_jobs,
birth_year = floor( runif(n_jobs, min = 1960, max = 1980) ),
firm_id1 = floor( abs( rnorm( n_jobs) )*1E2 ))
for(i in 2:19) {
job_data[, paste0("move",i) := as.integer( runif(n_jobs) < p_move ) ]
job_data[get(paste0("move",i))==1, paste0("firm_id",i) := floor( abs( rnorm( .N ) )*1E2 ) ]
job_data[get(paste0("move",i))==0, paste0("firm_id",i) := get(paste0("firm_id",i-1)) ]
}
job_data <- job_data %>%
select(-starts_with("move"))
job_data <- job_data %>%
pivot_longer(cols = starts_with("firm_id"),
names_to = "year",
values_to = "firm_id",
names_prefix = "firm_id") %>%
mutate(year = as.numeric(year)+2000)
n_firms <- max(job_data$firm_id)
# will now create earnings variables using an akm structure (person and firm effects will be recovered later)
job_data <- job_data %>%
select(person_id) %>%
distinct() %>%
mutate(person_effect = rnorm(n = n())*10) %>%
full_join(y = job_data, multiple= "all")
job_data <- job_data %>%
select(firm_id) %>%
distinct() %>%
mutate(firm_effect = rnorm(n = n())*5) %>%
full_join(y = job_data, multiple = "all")
job_data <- job_data %>%
select(year) %>%
distinct() %>%
mutate(year_effect = rnorm(n = n())*2) %>%
full_join(y = job_data, multiple = "all")
job_data <- job_data %>%
mutate(age = year - birth_year)
fe_data <- job_data %>%
select(person_id, firm_id, year, person_effect, firm_effect, year_effect)
job_data <- job_data %>%
mutate(log_earnings = firm_effect + person_effect + year_effect + 0.001*age - 0.002*age^2 + rnorm( n() ) ) %>%
select(-ends_with("effect")) %>%
as.data.table()
cat("\njob data for export:\n")
setkey(job_data, person_id, year)
glimpse(job_data)
saveRDS(job_data, file = paste0(main_directory, "/public_use/data/job_data.rds"))
saveRDS(fe_data, file = paste0(main_directory, "/public_use/data/fe_data.rds"))
log_close()
glimpse(job_data)
View(fe_data)
View(job_data)
# -------------------------------------------------------------------------------------------------------------------- #
# Copyright 2023 Stephen Tino                                                                                          #
#                                                                                                                      #
# This file is part of estimate_akm                                                                                    #
#                                                                                                                      #
# estimate_akm is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser General    #
# Public License as published by the Free Software Foundation, either version 2.1 of the License, or (at your option)  #
# any later version.                                                                                                   #
#                                                                                                                      #
# estimate_akm is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied   #
# warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more  #
# details.                                                                                                             #
#                                                                                                                      #
# You should have received a copy of the GNU Lesser General Public License along with estimate_akm. If not, see        #
# <https://www.gnu.org/licenses/>.                                                                                     #
# -------------------------------------------------------------------------------------------------------------------- #
rm(list = ls())
library("data.table")
library("dplyr")
library("ggm")
library("Matrix")
library("SparseM")
library("reshape2")
library("igraph")
library("zoo")
library("broom")
library("lfe")
main_directory <- "/Users/jonathanlatner/Google Drive/My Drive/IAB/D01700-LatnerWunder/akm/estimate_akm-main"
source(paste0(main_directory,"/public_use/code/utils/akm_functions.R"))
source(paste0(main_directory,"/public_use/code/utils/functions_1.R"))
log_path <- file(paste0(main_directory,"/public_use/logs/3_two_step_akm.txt"), open = "wt")
log_open(log_path)
# load data ---------------------------------------------------------------
main_data <- vload(main_directory, "job_data")
main_data <- main_data[, .(person_id,
year,
firm_id,
age,
age_sq = age^2,
log_earnings)]
View(main_data)
exp(-7.247)
exp(-1)
exp(1)
print(exp(1))
# -------------------------------------------------------------------------------------------------------------------- #
# Copyright 2023 Stephen Tino                                                                                          #
#                                                                                                                      #
# This file is part of estimate_akm                                                                                    #
#                                                                                                                      #
# estimate_akm is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser General    #
# Public License as published by the Free Software Foundation, either version 2.1 of the License, or (at your option)  #
# any later version.                                                                                                   #
#                                                                                                                      #
# estimate_akm is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied   #
# warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more  #
# details.                                                                                                             #
#                                                                                                                      #
# You should have received a copy of the GNU Lesser General Public License along with estimate_akm. If not, see        #
# <https://www.gnu.org/licenses/>.                                                                                     #
# -------------------------------------------------------------------------------------------------------------------- #
rm(list = ls())
library("data.table")
library("dplyr")
library("ggm")
library("Matrix")
library("SparseM")
library("reshape2")
library("igraph")
library("zoo")
library("broom")
library("lfe")
main_directory <- "/Users/jonathanlatner/Google Drive/My Drive/IAB/D01700-LatnerWunder/akm/estimate_akm-main"
source(paste0(main_directory,"/public_use/code/utils/akm_functions.R"))
source(paste0(main_directory,"/public_use/code/utils/functions_1.R"))
# -------------------------------------------------------------------------------------------------------------------- #
# Copyright 2023 Stephen Tino                                                                                          #
#                                                                                                                      #
# This file is part of estimate_akm                                                                                    #
#                                                                                                                      #
# estimate_akm is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser General    #
# Public License as published by the Free Software Foundation, either version 2.1 of the License, or (at your option)  #
# any later version.                                                                                                   #
#                                                                                                                      #
# estimate_akm is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied   #
# warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more  #
# details.                                                                                                             #
#                                                                                                                      #
# You should have received a copy of the GNU Lesser General Public License along with estimate_akm. If not, see        #
# <https://www.gnu.org/licenses/>.                                                                                     #
# -------------------------------------------------------------------------------------------------------------------- #
rm(list = ls())
library("data.table")
library("dplyr")
library("ggm")
library("Matrix")
library("SparseM")
library("reshape2")
library("igraph")
library("zoo")
library("broom")
library("lfe")
main_directory <- "/Users/jonathanlatner/Google Drive/My Drive/IAB/D01700-LatnerWunder/akm/estimate_akm-main"
source(paste0(main_directory,"/public_use/code/utils/akm_functions.R"))
source(paste0(main_directory,"/public_use/code/utils/functions_1.R"))
main_data <- vload(main_directory, "job_data")
View(main_data)
exp(-1)
exp(-7.247)
table(main_data$birth_year)
# -------------------------------------------------------------------------------------------------------------------- #
# Copyright 2023 Stephen Tino                                                                                          #
#                                                                                                                      #
# This file is part of estimate_akm                                                                                    #
#                                                                                                                      #
# estimate_akm is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser General    #
# Public License as published by the Free Software Foundation, either version 2.1 of the License, or (at your option)  #
# any later version.                                                                                                   #
#                                                                                                                      #
# estimate_akm is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied   #
# warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more  #
# details.                                                                                                             #
#                                                                                                                      #
# You should have received a copy of the GNU Lesser General Public License along with estimate_akm. If not, see        #
# <https://www.gnu.org/licenses/>.                                                                                     #
# -------------------------------------------------------------------------------------------------------------------- #
rm(list = ls())
library("data.table")
library("dplyr")
library("ggm")
library("Matrix")
library("SparseM")
library("reshape2")
library("igraph")
library("zoo")
library("broom")
library("lfe")
main_directory <- "/Users/jonathanlatner/Google Drive/My Drive/IAB/D01700-LatnerWunder/akm/estimate_akm-main"
source(paste0(main_directory,"/public_use/code/utils/akm_functions.R"))
source(paste0(main_directory,"/public_use/code/utils/functions_1.R"))
log_path <- file(paste0(main_directory,"/public_use/logs/3_two_step_akm.txt"), open = "wt")
log_open(log_path)
# load data ---------------------------------------------------------------
main_data <- vload(main_directory, "job_data")
main_data <- main_data[, .(person_id,
year,
firm_id,
age,
age_sq = age^2,
log_earnings)]
cat("\ndata before final data cleaning:\n")
glimpse(main_data)
main_data <- get_akm_data(main_data) # this function applies some filters to the data for akm estimation
# residualize log wages for two-way FE estimation -------------------------
# note: since age is perfectly colinear with birth year and the akm regression includes individual FE
# therefore I exclude the linear term of the quartic polynomial in age in the regression below
# this follows the literature (e.g. Dostie et al. 2021 and Li et al. 2023)
cat("\nbeginning residualization of log wage...")
est <- felm(log_earnings ~ age_sq | year, data = main_data)
main_data$resid <- est$residuals
rm(est)
cat("\n\nfinished residualizing log earnings. Data is ready for akm estimation.\n")
# estimate model and extract results --------------------------------------
cat("\n\n\nbeginning estimation of FE model....")
est <- felm(resid ~ 1 | person_id + firm_id, data = main_data)
cat("\n\n\n")
cat("estimation of FE model complete. Results:\n")
summary(est)
cat("\nExtracting FEs....")
fe <- getfe(est)
rm(est)
cat("\n\nExtraction of FE complete. Saving FEs...")
vsave(fe, main_directory, "two_step_est_fe_data")
cat("FEs saved.")
# variance decomposition --------------------------------------------------
fe <- as.data.table(fe)
main_data <- get_decomp_data(main_data, fe) # this function merges the FEs into the data with earnings
rm(fe)
results <- var_decomp(y = main_data$log_earnings,
worker_fe = main_data$worker_fe,
firm_fe = main_data$firm_fe)
results
View(results)
options(scipen = 9999) # disable scientific notation
View(results)
reticulate::repl_python()
# Load necessary library
library(dplyr)
# Set seed for reproducibility
set.seed(123)
# Number of observations
n <- 1000
# Define the 16 possible combinations of four binary variables
combinations <- expand.grid(y1 = c(0, 1), y2 = c(0, 1), y3 = c(0, 1), y4 = c(0, 1))
# Define c_16 and C_−16
c_16 <- combinations[16,]
C_minus_16 <- combinations[-16,]
# Initialize the dataset
D <- data.frame(matrix(ncol = 4, nrow = n))
colnames(D) <- c("y1", "y2", "y3", "y4")
# Sample the first 999 observations from C_minus_16 with equal probability
for (i in 1:(n-1)) {
sampled_row <- sample(1:15, 1)
D[i,] <- C_minus_16[sampled_row,]
}
# Set the 1000th observation to c_16
D[1000,] <- c_16
# Convert to data frame and print the first few rows
D <- as.data.frame(D)
head(D)
View(D)
df_frequency <- as.data.frame(table(D))
df_frequency$original <- (df_frequency$Freq / nrow(df_ods)) * 100
df_frequency <- as.data.frame(table(D))
df_frequency$original <- (df_frequency$Freq / nrow(D)) * 100
df_frequency
# Top commands ----
# Create empty R application (no figures, data frames, packages, etc.)
# Get a list of all loaded packages
packages <- search()[grepl("package:", search())]
# Unload each package
for (package in packages) {
unloadNamespace(package)
}
rm(list=ls(all=TRUE))
# load library
library(synthpop)
library(tidyverse)
# FOLDERS - ADAPT THIS PATHWAY
main_dir = "/Users/jonathanlatner/Documents/GitHub/KEM_GAN/latner/projects/simulation/"
data_files = "data_files/"
original_data = "data_files/original/"
synthpop_data = "data_files/synthetic/synthpop/"
datasynthesizer_data = "data_files/synthetic/datasynthesizer/"
setwd(main_dir)
#functions
options(scipen=999)
# load original data ----
df_ods <- read.csv(paste0(original_data,"simulated.csv"))
# Graph frequency by variable ----
# Reshape the data for plotting
df_ods_long <- df_ods %>%
pivot_longer(cols = starts_with("var"), names_to = "variable", values_to = "value") %>%
mutate(value = as.factor(value)) %>%
group_by(variable,value) %>%
tally() %>%
group_by(variable) %>%
mutate(total = sum(n),
pct = n/total) %>%
ungroup()
df_ods_long
# Plot using facet_wrap
ggplot(df_ods_long, aes(x = value, y=n)) +
geom_bar(color = "black", stat = 'identity') +
geom_text(aes(label = n),vjust = -0.5, size = 4) +
facet_wrap(~variable, scales = "free") +
theme_bw() +
scale_y_continuous(limits = c(0,700), breaks = seq(0,700,100)) +
theme(panel.grid.minor = element_blank(),
axis.title = element_blank(),
axis.line.y = element_line(color="black", linewidth=.5),
axis.line.x = element_line(color="black", linewidth=.5)
)
# Graph frequency by id ----
df_frequency <- df_ods
df_frequency$combine <- paste(df_frequency$var1, df_frequency$var2, df_frequency$var3, df_frequency$var4, sep = "")
df_frequency <- df_frequency %>%
select(-matches("var"))
df_frequency <- as.data.frame(table(df_frequency))
df_frequency$pct <- (df_frequency$Freq / nrow(df_ods)) * 100
ggplot(df_frequency, aes(x = combine, y = Freq)) +
geom_bar(stat = "identity", position = position_dodge()) +
ylab("Frequency") +
theme_bw() +
scale_y_continuous(limits = c(0,100), breaks = seq(0,100,10)) +
geom_text(aes(label = Freq),vjust = -0.5, size = 4) +
theme(panel.grid.minor = element_blank(),
legend.position = "bottom",
legend.title = element_blank(),
legend.key.width=unit(1, "cm"),
axis.title.x = element_blank(),
axis.line.y = element_line(color="black", linewidth=.5),
axis.line.x = element_line(color="black", linewidth=.5)
)
# Top commands ----
# Create empty R application (no figures, data frames, packages, etc.)
# Get a list of all loaded packages
packages <- search()[grepl("package:", search())]
# Unload each package
for (package in packages) {
unloadNamespace(package)
}
rm(list=ls(all=TRUE))
# load library
library(synthpop)
library(tidyverse)
# FOLDERS - ADAPT THIS PATHWAY
main_dir = "/Users/jonathanlatner/Documents/GitHub/KEM_GAN/latner/projects/simulation/"
data_files = "data_files/"
original_data = "data_files/original/"
synthpop_data = "data_files/synthetic/synthpop/"
datasynthesizer_data = "data_files/synthetic/datasynthesizer/"
setwd(main_dir)
#functions
options(scipen=999)
# load data ----
df_synthpop <- read.csv(paste0(synthpop_data,"synthpop_roc_values.csv"))
df_datasynthesizer <- read.csv(paste0(datasynthesizer_data,"datasynthesizer_roc_values.csv"))
# prepare ----
df_synthpop <- df_synthpop %>%
rename(roc = value,
variable = name)
df_synthpop$synthesizer <- "synthpop"
df_datasynthesizer <- df_datasynthesizer %>%
rename(roc = ROC.Value,
variable = Variable)
df_datasynthesizer$synthesizer <- paste0("DP_",df_datasynthesizer$epsilon)
# combine
df_compare <- bind_rows(df_synthpop,df_datasynthesizer) %>%
group_by(synthesizer, number) %>%
summarise(mean_roc = mean(roc)) %>%
ungroup()
# graph ----
ggplot(df_compare, aes(x = synthesizer, y = roc)) +
geom_boxplot(position = position_dodge(width=0.9)) +
facet_wrap(~variable) +
# geom_text(aes(label = label2), hjust = -0.5, size = 3, position = position_dodge(width=.9), angle = 90) +
ylab("ROC value") +
theme_bw() +
theme(panel.grid.minor = element_blank(),
legend.position = "bottom",
legend.title = element_blank(),
legend.key.width=unit(1, "cm"),
axis.text.x = element_text(angle = 25, hjust = 1, vjust = .5),
axis.title.x = element_blank(),
axis.line.y = element_line(color="black", linewidth=.5),
axis.line.x = element_line(color="black", linewidth=.5)
)
# Top commands ----
# Create empty R application (no figures, data frames, packages, etc.)
# Get a list of all loaded packages
packages <- search()[grepl("package:", search())]
# Unload each package
for (package in packages) {
unloadNamespace(package)
}
rm(list=ls(all=TRUE))
# load library
library(synthpop)
library(tidyverse)
# FOLDERS - ADAPT THIS PATHWAY
main_dir = "/Users/jonathanlatner/Documents/GitHub/KEM_GAN/latner/projects/simulation/"
data_files = "data_files/"
original_data = "data_files/original/"
synthpop_data = "data_files/synthetic/synthpop/"
datasynthesizer_data = "data_files/synthetic/datasynthesizer/"
setwd(main_dir)
#functions
options(scipen=999)
# load data ----
df_synthpop <- read.csv(paste0(synthpop_data,"synthpop_roc_values.csv"))
df_datasynthesizer <- read.csv(paste0(datasynthesizer_data,"datasynthesizer_roc_values.csv"))
# prepare ----
df_synthpop <- df_synthpop %>%
rename(roc = value,
variable = name)
df_synthpop$synthesizer <- "synthpop"
df_datasynthesizer <- df_datasynthesizer %>%
rename(roc = ROC.Value,
variable = Variable)
df_datasynthesizer$synthesizer <- paste0("DP_",df_datasynthesizer$epsilon)
# combine
df_compare <- bind_rows(df_synthpop,df_datasynthesizer) %>%
group_by(synthesizer, number) %>%
mutate(mean_roc = mean(roc)) %>%
ungroup()
# graph ----
ggplot(df_compare, aes(x = synthesizer, y = roc)) +
geom_boxplot(position = position_dodge(width=0.9)) +
facet_wrap(~variable) +
# geom_text(aes(label = label2), hjust = -0.5, size = 3, position = position_dodge(width=.9), angle = 90) +
ylab("ROC value") +
theme_bw() +
theme(panel.grid.minor = element_blank(),
legend.position = "bottom",
legend.title = element_blank(),
legend.key.width=unit(1, "cm"),
axis.text.x = element_text(angle = 25, hjust = 1, vjust = .5),
axis.title.x = element_blank(),
axis.line.y = element_line(color="black", linewidth=.5),
axis.line.x = element_line(color="black", linewidth=.5)
)
# Top commands ----
# Create empty R application (no figures, data frames, packages, etc.)
# Get a list of all loaded packages
packages <- search()[grepl("package:", search())]
# Unload each package
for (package in packages) {
unloadNamespace(package)
}
rm(list=ls(all=TRUE))
# load library
library(synthpop)
library(tidyverse)
library(readr)
library(ggh4x)
# FOLDERS - ADAPT THIS PATHWAY
main_dir = "/Users/jonathanlatner/Documents/GitHub/KEM_GAN/latner/projects/simulation/"
data_files = "data_files/"
original_data = "data_files/original/"
synthpop_data = "data_files/synthetic/synthpop/"
datasynthesizer_data = "data_files/synthetic/datasynthesizer/"
setwd(main_dir)
#functions
options(scipen=999)
# load original data ----
df_ods <- read.csv(paste0(original_data,"simulated.csv"))
df_ods <- as.data.frame(table(df_ods))
df_ods$synthesizer <- "original"
df_ods$combine <- paste(df_ods$var1, df_ods$var2, df_ods$var3, df_ods$var4, sep = "")
df_ods <- df_ods %>%
select(-matches("var"))
df_ods
# Load synthetic data from synthpop ----
df_synthpop <- read_csv(paste0(synthpop_data,"synthpop_frequency.csv"))
df_synthpop$synthesizer <- "synthpop"
df_synthpop
# Load synthetic data from datasynthesizer ----
df_datasynthesizer <- read_csv(paste0(datasynthesizer_data,"datasynthesizer_frequency.csv"))
df_datasynthesizer$synthesizer <- paste0("DP_",df_datasynthesizer$epsilon)
# Graph frequency ----
df_compare <- bind_rows(df_ods,df_synthpop,df_datasynthesizer)  %>%
filter(combine == "1111")
ggplot(df_compare, aes(x = synthesizer, y = Freq)) +
geom_boxplot(position = position_dodge(width=0.9)) +
theme_bw() +
theme(panel.grid.minor = element_blank(),
legend.position = "bottom",
legend.title = element_blank(),
legend.key.width=unit(1, "cm"),
axis.title.x = element_blank(),
axis.line.y = element_line(color="black", linewidth=.5),
axis.line.x = element_line(color="black", linewidth=.5)
)
.47*.45*.48*.45
